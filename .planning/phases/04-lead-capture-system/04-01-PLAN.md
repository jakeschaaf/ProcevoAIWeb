---
phase: 04-lead-capture-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - package.json
  - package-lock.json
  - app/api/contact/route.ts
  - lib/email.ts
  - lib/telegram.ts
  - lib/contact-schema.ts
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery for contact form submissions"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify procevo.ai domain (or use onboarding@resend.dev for testing)"
        location: "Resend Dashboard -> Domains -> Add Domain"
  - service: telegram
    why: "Instant mobile notifications for new leads"
    env_vars:
      - name: TELEGRAM_BOT_TOKEN
        source: "Message @BotFather on Telegram -> /newbot -> copy token"
      - name: TELEGRAM_CHAT_ID
        source: "Message your bot, then curl https://api.telegram.org/bot<TOKEN>/getUpdates to get chat.id"

must_haves:
  truths:
    - "Contact form API endpoint accepts POST requests at /api/contact"
    - "Valid submissions send email via Resend"
    - "Valid submissions trigger Telegram notification"
    - "Invalid submissions return 400 with validation errors"
    - "Honeypot field catches bot submissions"
  artifacts:
    - path: "next.config.ts"
      provides: "Next.js config without output: 'export'"
      contains: "NOT output.*export"
    - path: "app/api/contact/route.ts"
      provides: "POST handler for contact form"
      exports: ["POST"]
    - path: "lib/email.ts"
      provides: "Resend email utility"
      exports: ["sendContactEmail"]
    - path: "lib/telegram.ts"
      provides: "Telegram notification utility"
      exports: ["sendTelegramNotification"]
    - path: "lib/contact-schema.ts"
      provides: "Zod validation schema"
      exports: ["contactSchema"]
  key_links:
    - from: "app/api/contact/route.ts"
      to: "lib/email.ts"
      via: "import and call sendContactEmail"
      pattern: "sendContactEmail"
    - from: "app/api/contact/route.ts"
      to: "lib/telegram.ts"
      via: "import and call sendTelegramNotification"
      pattern: "sendTelegramNotification"
    - from: "app/api/contact/route.ts"
      to: "lib/contact-schema.ts"
      via: "import and use contactSchema.parse"
      pattern: "contactSchema"
---

<objective>
Set up backend infrastructure for contact form: remove static export, install dependencies, and create API route with email and Telegram notifications.

Purpose: Enable server-side form processing - the foundation for lead capture. Static export must be removed to allow Route Handlers on Vercel.

Output: Working /api/contact POST endpoint that validates input, sends email via Resend, and triggers Telegram notification.
</objective>

<execution_context>
@/Users/jakeschaaf/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakeschaaf/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-lead-capture-system/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove static export and install dependencies</name>
  <files>next.config.ts, package.json</files>
  <action>
1. Update next.config.ts to REMOVE `output: "export"`:
   - Keep `images: { unoptimized: true }` for now (can remove later if using Vercel Image Optimization)
   - This enables Route Handlers to work on Vercel as serverless functions

2. Install required dependencies:
   ```bash
   npm install resend react-hook-form zod @hookform/resolvers
   ```

3. Verify dev server still starts:
   ```bash
   npm run dev
   ```

IMPORTANT: Removing `output: "export"` is REQUIRED for API routes. Without this change, the build will fail.
  </action>
  <verify>
- `npm run dev` starts without errors
- `grep -q "output" next.config.ts` returns nothing (output: export removed)
- `grep -q "resend" package.json` returns match (dependency installed)
  </verify>
  <done>
- next.config.ts no longer has `output: "export"`
- resend, react-hook-form, zod, @hookform/resolvers are in package.json dependencies
- Dev server runs successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Create contact form API route with validation, email, and Telegram</name>
  <files>app/api/contact/route.ts, lib/email.ts, lib/telegram.ts, lib/contact-schema.ts</files>
  <action>
1. Create lib/contact-schema.ts with shared Zod schema:
   ```typescript
   import { z } from 'zod';

   export const contactSchema = z.object({
     email: z.string().email('Please enter a valid email address'),
     name: z.string().optional(),
     company: z.string().optional(),
     message: z.string().min(1, 'Please enter a message').max(2000, 'Message too long'),
     // Honeypot field - should always be empty
     website: z.string().max(0).optional(),
   });

   export type ContactFormData = z.infer<typeof contactSchema>;
   ```

2. Create lib/email.ts for Resend integration:
   ```typescript
   import { Resend } from 'resend';
   import type { ContactFormData } from './contact-schema';

   const resend = new Resend(process.env.RESEND_API_KEY);

   export async function sendContactEmail(data: ContactFormData): Promise<void> {
     await resend.emails.send({
       from: 'Contact Form <contact@procevo.ai>',
       to: ['jake@procevo.ai'],
       replyTo: data.email,
       subject: `New Contact: ${data.name || 'Website Visitor'}${data.company ? ` from ${data.company}` : ''}`,
       text: formatEmailText(data),
     });
   }

   function formatEmailText(data: ContactFormData): string {
     return [
       `Email: ${data.email}`,
       data.name ? `Name: ${data.name}` : null,
       data.company ? `Company: ${data.company}` : null,
       '',
       'Message:',
       data.message,
     ].filter(Boolean).join('\n');
   }
   ```

3. Create lib/telegram.ts for instant notifications:
   ```typescript
   import type { ContactFormData } from './contact-schema';

   export async function sendTelegramNotification(data: ContactFormData): Promise<void> {
     const botToken = process.env.TELEGRAM_BOT_TOKEN;
     const chatId = process.env.TELEGRAM_CHAT_ID;

     if (!botToken || !chatId) {
       console.warn('Telegram credentials not configured, skipping notification');
       return;
     }

     const text = [
       '*New Contact Form Submission*',
       '',
       `Email: ${data.email}`,
       data.name ? `Name: ${data.name}` : null,
       data.company ? `Company: ${data.company}` : null,
       '',
       'Message:',
       data.message,
     ].filter(Boolean).join('\n');

     const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({
         chat_id: chatId,
         text,
         parse_mode: 'Markdown',
       }),
     });

     if (!response.ok) {
       console.error('Telegram notification failed:', await response.text());
     }
   }
   ```

4. Create app/api/contact/route.ts as the API endpoint:
   ```typescript
   import { contactSchema } from '@/lib/contact-schema';
   import { sendContactEmail } from '@/lib/email';
   import { sendTelegramNotification } from '@/lib/telegram';
   import { ZodError } from 'zod';

   export async function POST(request: Request) {
     try {
       const body = await request.json();

       // Honeypot check - bots fill hidden fields
       if (body.website) {
         // Silently "succeed" to not tip off bots
         return Response.json({ success: true });
       }

       const validated = contactSchema.parse(body);

       // Send notifications in parallel for speed
       await Promise.all([
         sendContactEmail(validated),
         sendTelegramNotification(validated),
       ]);

       return Response.json({ success: true });
     } catch (error) {
       if (error instanceof ZodError) {
         return Response.json(
           { error: 'Validation failed', details: error.errors },
           { status: 400 }
         );
       }
       console.error('Contact form error:', error);
       return Response.json(
         { error: 'An error occurred. Please try again.' },
         { status: 500 }
       );
     }
   }
   ```

IMPORTANT:
- Use `import type` for type-only imports per CLAUDE.md C-6
- Email and Telegram calls are parallel via Promise.all for faster response
- Honeypot silently succeeds to avoid tipping off bots
- Error handling distinguishes validation errors (400) from server errors (500)
  </action>
  <verify>
- All four files exist: lib/contact-schema.ts, lib/email.ts, lib/telegram.ts, app/api/contact/route.ts
- `npm run build` succeeds (no TypeScript errors)
- Manual test with curl (without env vars, should return 500 for missing Resend key):
  ```bash
  curl -X POST http://localhost:3000/api/contact \
    -H "Content-Type: application/json" \
    -d '{"email": "test@example.com", "message": "Test message"}'
  ```
  </verify>
  <done>
- lib/contact-schema.ts exports contactSchema and ContactFormData type
- lib/email.ts exports sendContactEmail function
- lib/telegram.ts exports sendTelegramNotification function
- app/api/contact/route.ts exports POST handler
- API validates input with Zod, catches honeypot submissions, sends parallel notifications
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Build check:**
   ```bash
   npm run build
   ```
   Should succeed without errors (confirms static export removal worked)

2. **API structure check:**
   ```bash
   ls -la app/api/contact/
   ls -la lib/
   ```
   Should show route.ts and all lib files

3. **Endpoint test (dev server):**
   ```bash
   # Start dev server in background, then test
   curl -X POST http://localhost:3000/api/contact \
     -H "Content-Type: application/json" \
     -d '{"email": "test@example.com", "message": "Hello"}'
   ```
   Should return JSON response (success or error based on env vars)

4. **Validation test:**
   ```bash
   curl -X POST http://localhost:3000/api/contact \
     -H "Content-Type: application/json" \
     -d '{"email": "not-an-email", "message": ""}'
   ```
   Should return 400 with validation errors
</verification>

<success_criteria>
- next.config.ts no longer contains `output: "export"`
- All dependencies installed (resend, react-hook-form, zod, @hookform/resolvers)
- /api/contact POST endpoint exists and handles requests
- Zod validation rejects invalid input with 400 status
- Honeypot field catches bot submissions silently
- Email and Telegram functions are called in parallel
- Build succeeds (no TypeScript errors, no static export conflicts)
</success_criteria>

<output>
After completion, create `.planning/phases/04-lead-capture-system/04-01-SUMMARY.md`
</output>
